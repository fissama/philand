version: '3.8'

services:
  # MySQL Database
  database:
    image: mysql:8.0
    container_name: philand-database
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: philand
      MYSQL_USER: philand
      MYSQL_PASSWORD: philand
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - philand-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Rust Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: philand-backend
    restart: unless-stopped
    environment:
      # Database Configuration
      DB_URL: mysql://philand:philand@database:3306/philand
      
      # Network Configuration
      NET_HOST: 0.0.0.0
      NET_PORT: 8080
      
      # CORS Configuration
      CORS_ORIGINS: http://localhost:3000,http://frontend:3000
      
      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET:-dev-super-secret-change-me-in-production}
      JWT_TTL_MIN: ${JWT_TTL_MIN:-10080}
      BCRYPT_COST: ${BCRYPT_COST:-12}
      
      # Password Reset TTLs (minutes)
      RESET_TOKEN_TTL_MIN: ${RESET_TOKEN_TTL_MIN:-15}
      RESET_OTP_TTL_MIN: ${RESET_OTP_TTL_MIN:-10}
      
      # Rate Limiting Configuration
      AUTH_RATE_LIMIT_SHORT_WINDOW_SEC: ${AUTH_RATE_LIMIT_SHORT_WINDOW_SEC:-10}
      AUTH_RATE_LIMIT_SHORT_MAX: ${AUTH_RATE_LIMIT_SHORT_MAX:-8}
      AUTH_RATE_LIMIT_LONG_WINDOW_SEC: ${AUTH_RATE_LIMIT_LONG_WINDOW_SEC:-600}
      AUTH_RATE_LIMIT_LONG_MAX: ${AUTH_RATE_LIMIT_LONG_MAX:-80}
      AUTH_FAIL_LOCK_THRESHOLD: ${AUTH_FAIL_LOCK_THRESHOLD:-10}
      AUTH_FAIL_LOCK_MIN: ${AUTH_FAIL_LOCK_MIN:-15}
      
      # Application Version
      APP_VERSION: ${APP_VERSION:-1.0.0}
      APP_NAME: ${APP_NAME:-Philand Budget Tracker}
    ports:
      - "8080:8080"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - philand-network
    volumes:
      - ./migrations:/app/migrations:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Next.js Frontend
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: philand-frontend
    restart: unless-stopped
    environment:
      # Next.js Configuration
      NEXT_PUBLIC_API_URL: http://localhost:8080
      NEXT_PUBLIC_APP_VERSION: ${APP_VERSION:-1.0.0}
      NEXT_PUBLIC_APP_NAME: ${APP_NAME:-Philand Budget Tracker}
      NEXT_PUBLIC_BUILD_DATE: ${BUILD_DATE}
      
      # Production settings
      NODE_ENV: production
      PORT: 3000
      HOSTNAME: 0.0.0.0
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - philand-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy (Optional)
  nginx:
    image: nginx:alpine
    container_name: philand-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
    networks:
      - philand-network
    profiles:
      - production

volumes:
  mysql_data:
    driver: local

networks:
  philand-network:
    driver: bridge